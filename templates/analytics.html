{% extends "base.html" %}

{% block title %}الإحصائيات المتقدمة - نظام مراقبة الأجهزة{% endblock %}

{% block content %}
<div class="analytics-page">
    <!-- شريط التنقل السريع -->
    <div class="quick-nav mb-4">
        <div class="card">
            <div class="card-body">
                <nav class="breadcrumb-nav">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('dashboard.index') }}" class="breadcrumb-link">
                                <i class="fas fa-home"></i>
                                الرئيسية
                            </a>
                        </li>
                        <li class="breadcrumb-item active">
                            <i class="fas fa-chart-line"></i>
                            الإحصائيات المتقدمة
                        </li>
                    </ol>
                </nav>
                
                <!-- روابط سريعة -->
                <div class="quick-links mt-3">
                    <div class="row">
                        <div class="col-md-3 col-sm-6 mb-2">
                            <a href="{{ url_for('dashboard.index') }}" class="quick-link-card">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>لوحة التحكم</span>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-2">
                            <a href="{{ url_for('devices.devices_list') }}" class="quick-link-card">
                                <i class="fas fa-desktop"></i>
                                <span>الأجهزة</span>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-2">
                            <a href="{{ url_for('alerts.alerts_list') }}" class="quick-link-card">
                                <i class="fas fa-bell"></i>
                                <span>التنبيهات</span>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-2">
                            <a href="{{ url_for('reports') }}" class="quick-link-card">
                                <i class="fas fa-chart-bar"></i>
                                <span>التقارير</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- رأس الصفحة -->
    <div class="page-header">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-chart-line"></i>
                            الإحصائيات المتقدمة
                        </h1>
                        <p class="page-subtitle">تحليلات مفصلة ورسوم بيانية تفاعلية لأداء النظام</p>
                    </div>
                    <div class="page-actions">
                        <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-primary">
                            <i class="fas fa-tachometer-alt"></i>
                            لوحة التحكم
                        </a>
                        <a href="{{ url_for('devices.devices_list') }}" class="btn btn-outline-warning">
                            <i class="fas fa-desktop"></i>
                            الأجهزة
                        </a>
                        <a href="{{ url_for('alerts.alerts_list') }}" class="btn btn-outline-info">
                            <i class="fas fa-bell"></i>
                            التنبيهات
                        </a>
                        <a href="{{ url_for('help') }}" class="btn btn-outline-warning">
                            <i class="fas fa-question-circle"></i>
                            المساعدة
                        </a>
                        <button class="btn btn-primary" onclick="refreshAnalytics()">
                            <i class="fas fa-sync-alt"></i>
                            تحديث البيانات
                        </button>
                        <button class="btn btn-success" onclick="exportAnalytics()">
                            <i class="fas fa-download"></i>
                            تصدير التحليلات
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فلاتر التحليل -->
    <div class="filters-section mb-4">
        <div class="card">
            <div class="card-body">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="time-range" class="filter-label">
                            <i class="fas fa-calendar-alt"></i>
                            الفترة الزمنية
                        </label>
                        <select id="time-range" class="form-control">
                            <option value="1h">آخر ساعة</option>
                            <option value="24h" selected>آخر 24 ساعة</option>
                            <option value="7d">آخر 7 أيام</option>
                            <option value="30d">آخر 30 يوم</option>
                            <option value="90d">آخر 90 يوم</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="metric-type" class="filter-label">
                            <i class="fas fa-chart-pie"></i>
                            نوع المقياس
                        </label>
                        <select id="metric-type" class="form-control">
                            <option value="all">جميع المقاييس</option>
                            <option value="performance">الأداء</option>
                            <option value="availability">التوفر</option>
                            <option value="alerts">التنبيهات</option>
                            <option value="usage">الاستخدام</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="device-filter" class="filter-label">
                            <i class="fas fa-desktop"></i>
                            الجهاز
                        </label>
                        <select id="device-filter" class="form-control">
                            <option value="">جميع الأجهزة</option>
                            {% if devices %}
                            {% for device in devices %}
                            <option value="{{ device.id }}">{{ device.name }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="applyAnalyticsFilters()">
                            <i class="fas fa-filter"></i>
                            تطبيق الفلاتر
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مقاييس الأداء الرئيسية -->
    <div class="kpi-section mb-4">
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="kpi-content">
                        <h3 class="kpi-value" id="kpi-availability">-</h3>
                        <p class="kpi-label">معدل التوفر</p>
                        <div class="kpi-trend positive" id="kpi-availability-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span id="kpi-availability-trend-value">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="kpi-content">
                        <h3 class="kpi-value" id="kpi-response-time">-</h3>
                        <p class="kpi-label">متوسط وقت الاستجابة</p>
                        <div class="kpi-trend positive" id="kpi-response-time-trend">
                            <i class="fas fa-arrow-down"></i>
                            <span id="kpi-response-time-trend-value">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="kpi-content">
                        <h3 class="kpi-value" id="kpi-alerts">-</h3>
                        <p class="kpi-label">التنبيهات النشطة</p>
                        <div class="kpi-trend negative" id="kpi-alerts-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span id="kpi-alerts-trend-value">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="kpi-content">
                        <h3 class="kpi-value" id="kpi-users">-</h3>
                        <p class="kpi-label" id="kpi-users-label">المستخدمون النشطون</p>
                        <div class="kpi-trend positive" id="kpi-users-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span id="kpi-users-trend-value">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- الرسوم البيانية التفاعلية -->
    <div class="charts-section mb-4">
        <div class="row">
            <!-- مخطط الأداء الزمني -->
            <div class="col-lg-8 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-area"></i>
                            أداء النظام عبر الوقت
                        </h3>
                        <div class="chart-controls">
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleChartType('line')">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleChartType('area')">
                                <i class="fas fa-chart-area"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- توزيع الأجهزة -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-pie"></i>
                            توزيع الأجهزة
                        </h3>
                    </div>
                    <div class="chart-body">
                        <canvas id="devices-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- مخطط التنبيهات -->
            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-bell"></i>
                            تحليل التنبيهات
                        </h3>
                    </div>
                    <div class="chart-body">
                        <canvas id="alerts-analysis-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- مخطط الاستخدام -->
            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            استخدام الموارد
                        </h3>
                    </div>
                    <div class="chart-body">
                        <canvas id="resource-usage-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- التحليلات المتقدمة -->
    <div class="advanced-analytics mb-4">
        <div class="row">
            <!-- تحليل الاتجاهات -->
            <div class="col-lg-6 mb-4">
                <div class="analytics-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-trending-up"></i>
                            تحليل الاتجاهات
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="trend-analysis" id="trends-list">
                            <div class="trend-item">
                                <div class="trend-indicator positive">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                                <div class="trend-content">
                                    <h5>جاري التحميل...</h5>
                                    <p>يرجى الانتظار...</p>
                                    <div class="trend-value">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- التوقعات -->
            <div class="col-lg-6 mb-4">
                <div class="analytics-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-crystal-ball"></i>
                            التوقعات والتنبؤات
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="predictions" id="predictions-list">
                            <div class="prediction-item">
                                <div class="prediction-icon">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                                <div class="prediction-content">
                                    <h5>جاري التحميل...</h5>
                                    <p>يرجى الانتظار...</p>
                                    <div class="prediction-probability medium">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- التقارير المخصصة -->
    <div class="custom-reports mb-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-cog"></i>
                    التقارير المخصصة
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="report-template">
                            <div class="template-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h5>تقرير الأداء اليومي</h5>
                            <p>تحليل شامل لأداء النظام اليومي</p>
                            <button class="btn btn-primary btn-sm" onclick="generateCustomReport('daily')">
                                إنشاء التقرير
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="report-template">
                            <div class="template-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <h5>تقرير التنبيهات الأسبوعي</h5>
                            <p>ملخص شامل للتنبيهات خلال الأسبوع</p>
                            <button class="btn btn-primary btn-sm" onclick="generateCustomReport('weekly')">
                                إنشاء التقرير
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="report-template">
                            <div class="template-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h5>تقرير الاستخدام الشهري</h5>
                            <p>تحليل استخدام النظام من قبل المستخدمين</p>
                            <button class="btn btn-primary btn-sm" onclick="generateCustomReport('monthly')">
                                إنشاء التقرير
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .analytics-page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* شريط التنقل السريع */
    .quick-nav .card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        box-shadow: var(--glass-shadow);
    }

    .breadcrumb {
        background: none;
        padding: 0;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .breadcrumb-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .breadcrumb-link {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .breadcrumb-link:hover {
        color: var(--primary);
        transform: translateY(-2px);
    }

    .breadcrumb-item.active {
        color: var(--primary);
        font-weight: 600;
    }

    /* الروابط السريعة */
    .quick-links {
        margin-top: 1rem;
    }

    .quick-link-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.5rem;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        text-decoration: none;
        color: white;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .quick-link-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .quick-link-card:hover::before {
        transform: scaleX(1);
    }

    .quick-link-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 15px 35px rgba(31, 38, 135, 0.4);
        color: white;
        text-decoration: none;
    }

    .quick-link-card i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        transition: all 0.3s ease;
    }

    .quick-link-card:hover i {
        transform: scale(1.1);
    }

    .quick-link-card span {
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* أزرار التنقل */
    .btn-outline-primary {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
    }

    .btn-outline-primary:hover {
        background: var(--primary);
        color: white;
    }

    .btn-outline-warning {
        background: transparent;
        color: var(--warning);
        border: 2px solid var(--warning);
    }

    .btn-outline-warning:hover {
        background: var(--warning);
        color: white;
    }

    .btn-outline-info {
        background: transparent;
        color: #17a2b8;
        border: 2px solid #17a2b8;
    }

    .btn-outline-info:hover {
        background: #17a2b8;
        color: white;
    }

    /* مقاييس الأداء الرئيسية */
    .kpi-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        box-shadow: var(--glass-shadow);
        padding: 2rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
    }

    .kpi-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 25px 50px rgba(31, 38, 135, 0.5);
    }

    .kpi-card .kpi-icon {
        font-size: 3rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
        animation: iconPulse 2s ease-in-out infinite;
    }

    @keyframes iconPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .kpi-label {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    .kpi-trend {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .kpi-trend.positive {
        color: #27ae60;
    }

    .kpi-trend.negative {
        color: #e74c3c;
    }

    /* الرسوم البيانية */
    .chart-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        box-shadow: var(--glass-shadow);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .chart-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
    }

    .chart-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(31, 38, 135, 0.5);
    }

    .chart-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-title {
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
    }

    .chart-title i {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .chart-controls {
        display: flex;
        gap: 0.5rem;
    }

    .chart-body {
        padding: 1.5rem;
        height: 400px;
        position: relative;
    }
    
    #performance-chart, #devices-distribution-chart {
        max-height: 400px !important;
    }
    
    #alerts-analysis-chart, #resource-usage-chart {
        max-height: 300px !important;
    }

    /* التحليلات المتقدمة */
    .analytics-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        box-shadow: var(--glass-shadow);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .analytics-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
    }

    .analytics-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(31, 38, 135, 0.5);
    }

    .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-title {
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
    }

    .card-title i {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* تحليل الاتجاهات */
    .trend-item {
        display: flex;
        align-items: center;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .trend-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }

    .trend-indicator {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-left: 1rem;
    }

    .trend-indicator.positive {
        background: rgba(39, 174, 96, 0.2);
        color: #27ae60;
    }

    .trend-indicator.negative {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
    }

    .trend-content {
        flex: 1;
    }

    .trend-content h5 {
        color: white;
        margin-bottom: 0.5rem;
    }

    .trend-content p {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0.5rem;
    }

    .trend-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
    }

    /* التوقعات */
    .prediction-item {
        display: flex;
        align-items: center;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .prediction-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }

    .prediction-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-left: 1rem;
        background: var(--primary-gradient);
        color: white;
    }

    .prediction-content {
        flex: 1;
    }

    .prediction-content h5 {
        color: white;
        margin-bottom: 0.5rem;
    }

    .prediction-content p {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0.5rem;
    }

    .prediction-probability {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .prediction-probability.high {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
    }

    .prediction-probability.medium {
        background: rgba(243, 156, 18, 0.2);
        color: #f39c12;
    }

    .prediction-probability.low {
        background: rgba(39, 174, 96, 0.2);
        color: #27ae60;
    }

    /* التقارير المخصصة */
    .report-template {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        height: 100%;
    }

    .report-template:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-5px);
    }

    .template-icon {
        font-size: 3rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
    }

    .report-template h5 {
        color: white;
        margin-bottom: 1rem;
    }

    .report-template p {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 1.5rem;
    }

    /* فلاتر التحليل */
    .filters-section .card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        box-shadow: var(--glass-shadow);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-label {
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-label i {
        color: var(--primary);
    }

    .form-control {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 10px;
    }

    .form-control:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);
        color: white;
    }

    .form-control option {
        background: #2c3e50;
        color: white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // متغيرات الرسوم البيانية
    let performanceChart = null;
    let devicesDistributionChart = null;
    let alertsAnalysisChart = null;
    let resourceUsageChart = null;
    
    // تطبيق فلاتر التحليلات
    function applyAnalyticsFilters() {
        const timeRange = document.getElementById('time-range').value;
        loadAllAnalytics(timeRange);
        showNotification('تم تطبيق الفلاتر', 'success');
    }

    // تحديث التحليلات
    function refreshAnalytics() {
        const timeRange = document.getElementById('time-range').value;
        loadAllAnalytics(timeRange);
        showNotification('تم تحديث البيانات', 'success');
    }

    // تصدير التحليلات
    function exportAnalytics() {
        showNotification('جاري تصدير التحليلات...', 'info');
        fetch('/analytics/api/export')
            .then(response => response.json())
            .then(data => {
                showNotification('تم تصدير التحليلات بنجاح', 'success');
            })
            .catch(error => {
                showNotification('حدث خطأ أثناء التصدير', 'error');
            });
    }

    // تبديل نوع الرسم البياني
    function toggleChartType(type) {
        if (performanceChart) {
            performanceChart.config.type = type === 'line' ? 'line' : 'line';
            performanceChart.update();
        }
        showNotification('تم تغيير نوع الرسم إلى: ' + type, 'info');
    }

    // إنشاء تقرير مخصص
    function generateCustomReport(type) {
        showNotification('جاري إنشاء تقرير ' + type + '...', 'info');
        setTimeout(() => {
            showNotification('تم إنشاء التقرير بنجاح', 'success');
        }, 2000);
    }

    // تحميل جميع التحليلات
    function loadAllAnalytics(timeRange = '24h') {
        loadKPI(timeRange);
        loadPerformance(timeRange);
        loadDevicesDistribution();
        loadAlertsAnalysis();
        loadResourceUsage();
        loadTrends();
        loadPredictions();
    }

    // تحميل KPIs
    function loadKPI(timeRange) {
        fetch(`/analytics/api/kpi?time_range=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading KPI:', data.error);
                    return;
                }
                
                document.getElementById('kpi-availability').textContent = data.availability + '%';
                document.getElementById('kpi-availability-trend-value').textContent = '+' + data.availability_trend + '%';
                
                document.getElementById('kpi-response-time').textContent = data.avg_response_time + 's';
                document.getElementById('kpi-response-time-trend-value').textContent = data.response_time_trend + 's';
                
                document.getElementById('kpi-alerts').textContent = data.active_alerts;
                document.getElementById('kpi-alerts-trend-value').textContent = data.alerts_trend;
                
                document.getElementById('kpi-users').textContent = data.active_users;
                document.getElementById('kpi-users-trend-value').textContent = data.users_trend;
                
                // تحديث تسمية المستخدمين حسب الدور
                const userRole = '{{ user_role }}';
                if (userRole !== 'admin' && userRole !== 'manager') {
                    document.getElementById('kpi-users-label').textContent = 'عدد الأجهزة';
                }
            })
            .catch(error => {
                console.error('Error loading KPI:', error);
            });
    }

    // تحميل بيانات الأداء
    function loadPerformance(timeRange) {
        fetch(`/analytics/api/performance?time_range=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading performance:', data.error);
                    return;
                }
                
                createPerformanceChart(data);
            })
            .catch(error => {
                console.error('Error loading performance:', error);
            });
    }

    // تحميل توزيع الأجهزة
    function loadDevicesDistribution() {
        fetch('/analytics/api/devices-distribution')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading devices distribution:', data.error);
                    return;
                }
                
                createDevicesDistributionChart(data);
            })
            .catch(error => {
                console.error('Error loading devices distribution:', error);
            });
    }

    // تحميل تحليل التنبيهات
    function loadAlertsAnalysis() {
        fetch('/analytics/api/alerts-analysis')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading alerts analysis:', data.error);
                    return;
                }
                
                createAlertsAnalysisChart(data);
            })
            .catch(error => {
                console.error('Error loading alerts analysis:', error);
            });
    }

    // تحميل استخدام الموارد
    function loadResourceUsage() {
        fetch('/analytics/api/resource-usage')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading resource usage:', data.error);
                    return;
                }
                
                createResourceUsageChart(data);
            })
            .catch(error => {
                console.error('Error loading resource usage:', error);
            });
    }

    // تحميل الاتجاهات
    function loadTrends() {
        fetch('/analytics/api/trends')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading trends:', data.error);
                    return;
                }
                
                const trendsList = document.getElementById('trends-list');
                trendsList.innerHTML = '';
                
                Object.keys(data).forEach(key => {
                    const trend = data[key];
                    const trendItem = document.createElement('div');
                    trendItem.className = 'trend-item';
                    trendItem.innerHTML = `
                        <div class="trend-indicator ${trend.trend}">
                            <i class="fas fa-arrow-${trend.trend === 'positive' ? 'up' : 'down'}"></i>
                        </div>
                        <div class="trend-content">
                            <h5>${key === 'performance' ? 'الأداء' : key === 'alerts' ? 'التنبيهات' : 'التوفر'}</h5>
                            <p>${trend.description}</p>
                            <div class="trend-value">${trend.trend === 'positive' ? '+' : ''}${trend.value}%</div>
                        </div>
                    `;
                    trendsList.appendChild(trendItem);
                });
            })
            .catch(error => {
                console.error('Error loading trends:', error);
            });
    }

    // تحميل التوقعات
    function loadPredictions() {
        fetch('/analytics/api/predictions')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading predictions:', data.error);
                    return;
                }
                
                const predictionsList = document.getElementById('predictions-list');
                predictionsList.innerHTML = '';
                
                data.predictions.forEach(prediction => {
                    const predictionItem = document.createElement('div');
                    predictionItem.className = 'prediction-item';
                    predictionItem.innerHTML = `
                        <div class="prediction-icon">
                            <i class="fas fa-${prediction.type === 'warning' ? 'exclamation-triangle' : prediction.type === 'success' ? 'check-circle' : 'arrow-up'}"></i>
                        </div>
                        <div class="prediction-content">
                            <h5>${prediction.title}</h5>
                            <p>${prediction.description}</p>
                            <div class="prediction-probability ${prediction.probability > 70 ? 'high' : prediction.probability > 50 ? 'medium' : 'low'}">${prediction.probability}%</div>
                        </div>
                    `;
                    predictionsList.appendChild(predictionItem);
                });
            })
            .catch(error => {
                console.error('Error loading predictions:', error);
            });
    }

    // إنشاء الرسوم البيانية
    document.addEventListener('DOMContentLoaded', function() {
        loadAllAnalytics('24h');
        
        // تحديث تلقائي كل 30 ثانية
        setInterval(() => {
            const timeRange = document.getElementById('time-range').value;
            loadAllAnalytics(timeRange);
        }, 30000);
    });

    function createPerformanceChart(data) {
        const ctx = document.getElementById('performance-chart');
        if (!ctx) return;
        
        if (performanceChart) {
            performanceChart.destroy();
        }
        
        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels || [],
                datasets: [
                    {
                        label: 'CPU',
                        data: data.cpu || [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'RAM',
                        data: data.ram || [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Disk',
                        data: data.disk || [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: 'white'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: 'white'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'white'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }

    function createDevicesDistributionChart(data) {
        const ctx = document.getElementById('devices-distribution-chart');
        if (!ctx) return;
        
        if (devicesDistributionChart) {
            devicesDistributionChart.destroy();
        }
        
        devicesDistributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['سليم', 'تحذير', 'حرج'],
                datasets: [{
                    data: [data.healthy || 0, data.warning || 0, data.critical || 0],
                    backgroundColor: [
                        '#27ae60',
                        '#f39c12',
                        '#e74c3c'
                    ],
                    borderWidth: 2,
                    borderColor: '#1a1a2e'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'white',
                            padding: 15
                        }
                    }
                }
            }
        });
    }

    function createAlertsAnalysisChart(data) {
        const ctx = document.getElementById('alerts-analysis-chart');
        if (!ctx) return;
        
        if (alertsAnalysisChart) {
            alertsAnalysisChart.destroy();
        }
        
        alertsAnalysisChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['حرج', 'تحذير', 'معلومات'],
                datasets: [{
                    label: 'عدد التنبيهات',
                    data: [data.critical || 0, data.warning || 0, data.info || 0],
                    backgroundColor: [
                        '#e74c3c',
                        '#f39c12',
                        '#3498db'
                    ],
                    borderWidth: 2,
                    borderColor: '#1a1a2e'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'white',
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'white'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }

    function createResourceUsageChart(data) {
        const ctx = document.getElementById('resource-usage-chart');
        if (!ctx) return;
        
        if (resourceUsageChart) {
            resourceUsageChart.destroy();
        }
        
        resourceUsageChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['CPU', 'RAM', 'Disk', 'Network'],
                datasets: [{
                    label: 'استخدام الموارد (%)',
                    data: [
                        data.cpu || 0,
                        data.ram || 0,
                        data.disk || 0,
                        data.network || 0
                    ],
                    backgroundColor: [
                        '#3498db',
                        '#e74c3c',
                        '#f39c12',
                        '#9b59b6'
                    ],
                    borderWidth: 2,
                    borderColor: '#1a1a2e'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: 'white'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'white'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }

    // دالة عرض الإشعارات
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    function showLoading() {
        // يمكن إضافة مؤشر تحميل هنا
    }

    function hideLoading() {
        // يمكن إخفاء مؤشر التحميل هنا
    }
</script>
{% endblock %}
{% endblock %}
